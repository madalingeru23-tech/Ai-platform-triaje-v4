<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Externare Ambulatoriu</title>

  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="/static/triaj.css" />
  <script src="/static/js/user.js" defer></script>

  <style>
    body {
      background: linear-gradient(135deg,#673ab7,#3f51b5);
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0;
      overflow-y: auto;
    }
    main {
      padding: 2rem;
      max-width: 1000px;
      margin: auto;
      overflow-y: auto;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .col {
      flex: 1 1 260px;
      min-width: 0;
    }
    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
    }
    input, textarea, select {
      width: 100%;
      padding: 0.5rem 0.6rem;
      box-sizing: border-box;
    }
    input[readonly] {
      background: #f5f5f5;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    .muted {
      color: #666;
      font-size: 0.85rem;
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.8rem;
    }
    button {
      border: none;
      border-radius: 10px;
      padding: 0.55rem 1.1rem;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .btn-primary {
      background: #5b2ff5;
      color: #fff;
    }
    .btn-primary:hover {
      background: #431bcc;
    }
    .btn-ghost {
      background: transparent;
      color: #5b2ff5;
      border: 1px solid #5b2ff5;
    }
    .btn-ghost:hover {
      background: rgba(91,47,245,0.06);
    }

    .status {
      margin-top: 0.4rem;
      font-size: 0.85rem;
    }
    .status.ok  { color: #2e7d32; }
    .status.err { color: #c62828; }

    .upload-list {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      padding-left: 1.2rem;
    }
    .upload-list li {
      margin-bottom: 2px;
    }

    .ai-hint {
      font-size: 0.8rem;
      color: #555;
      margin-bottom: 0.3rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .ai-hint span {
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ©º Externare Ã®n Ambulatoriu</h1>
    <p>Generare automatÄƒ a biletului de externare pentru pacienÈ›ii trataÈ›i Ã®n regim ambulator.</p>
  </header>

  <main>
    <!-- ðŸ”¹ DATE PACIENT -->
    <section class="card">
      <h2>Date pacient</h2>
      <p class="muted">Datele sunt preluate automat din ultimul triaj efectuat, dacÄƒ existÄƒ.</p>

      <div class="row">
        <div class="col">
          <label for="p_first_name">Prenume</label>
          <input id="p_first_name" type="text" readonly />
        </div>
        <div class="col">
          <label for="p_last_name">Nume</label>
          <input id="p_last_name" type="text" readonly />
        </div>
        <div class="col">
          <label for="p_cnp">CNP</label>
          <input id="p_cnp" type="text" readonly />
        </div>
      </div>

      <div class="row" style="margin-top:0.6rem;">
        <div class="col">
          <label for="p_triage_level">Nivel triaj</label>
          <input id="p_triage_level" type="text" readonly />
        </div>
        <div class="col">
          <label>Context triaj</label>
          <div id="triage_context" class="muted">Nu existÄƒ Ã®ncÄƒ un triaj recent salvat.</div>
        </div>
      </div>
    </section>

    <!-- ðŸ”¹ CONÈšINUT MEDICAL -->
    <section class="card">
      <h2>ConÈ›inut medical</h2>

      <div class="ai-hint">
        <span>ðŸ¤–</span>
        <span>PoÈ›i genera un prim draft cu ajutorul AI È™i apoi Ã®l modifici dupÄƒ caz.</span>
      </div>

      <div class="actions">
        <button type="button" class="btn-ghost" id="btn_ai_draft">GenereazÄƒ draft AI</button>
      </div>

      <div style="margin-top:0.8rem;">
        <label for="diag_txt">Diagnostic la externare</label>
        <textarea id="diag_txt" placeholder="Ex: Durere toracicÄƒ nespecificÄƒ, fÄƒrÄƒ semne de ischemie acutÄƒ..."></textarea>
      </div>

      <div style="margin-top:0.7rem;">
        <label for="evo_txt">EvoluÈ›ie / Motiv prezentare</label>
        <textarea id="evo_txt" placeholder="Ex: Pacientul s-a prezentat pentru..., pe durata monitorizÄƒrii..."></textarea>
      </div>

      <div style="margin-top:0.7rem;">
        <label for="rec_txt">RecomandÄƒri / ConduitÄƒ la domiciliu</label>
        <textarea id="rec_txt" placeholder="Ex: Tratament simptomatic cu..., reevaluare la..., prezentare de urgenÈ›Äƒ dacÄƒ..."></textarea>
      </div>
    </section>

    <!-- ðŸ”¹ UPLOAD INVESTIGAÈšII -->
    <section class="card">
      <h2>InvestigaÈ›ii ataÈ™ate</h2>
      <p class="muted">
        PoÈ›i Ã®ncÄƒrca fiÈ™iere PDF (analize, CT, RMN etc.) care vor fi ataÈ™ate ca pagini suplimentare la biletul de externare.
      </p>

      <input id="inv_files" type="file" multiple accept="application/pdf" />
      <div class="actions">
        <button type="button" class="btn-ghost" id="btn_upload_inv">ÃŽncarcÄƒ investigaÈ›iile selectate</button>
      </div>

      <div id="upload_status" class="status"></div>
      <ul id="upload_list" class="upload-list"></ul>
    </section>

    <!-- ðŸ”¹ GENERARE PDF -->
    <section class="card">
      <h2>Generare PDF externare</h2>
      <p class="muted">
        La generare, PDF-ul va include datele pacientului, conÈ›inutul completat mai sus È™i, pe paginile urmÄƒtoare,
        investigaÈ›iile PDF ataÈ™ate.
      </p>
      <div class="actions">
        <button type="button" class="btn-primary" id="btn_generate_pdf">ðŸ“„ GenereazÄƒ PDF de externare</button>
      </div>
      <div id="pdf_status" class="status"></div>
    </section>
  </main>

  <script>
    // ðŸ”¹ lista globalÄƒ trimisÄƒ backend-ului
    const uploadedInvestigations = [];

    /* -------------------------------------------------------
       TRIAJ DIN localStorage
    ------------------------------------------------------- */
    function loadLastTriage() {
      const raw = localStorage.getItem("last_triage");
      if (!raw) return;

      try {
        const data = JSON.parse(raw);

        document.getElementById("p_first_name").value = data.first_name || "";
        document.getElementById("p_last_name").value  = data.last_name  || "";
        document.getElementById("p_cnp").value        = data.cnp        || "";
        document.getElementById("p_triage_level").value = data.level || "";

        const lvl = data.level || "?";
        const ctx = document.getElementById("triage_context");
        ctx.textContent = `Ultimul triaj: nivel ${lvl}`;
      } catch (e) {
        console.error("Eroare la citirea last_triage:", e);
      }
    }

    /* -------------------------------------------------------
       DRAFT AI SIMPLU
    ------------------------------------------------------- */
    function generateAiDraft() {
      const last = localStorage.getItem("last_triage");
      let level = 3;
      let reason = "";

      if (last) {
        try {
          const d = JSON.parse(last);
          level = d.level || 3;
          reason = d.reason || "";
        } catch {}
      }

      let diag = "";
      let evo  = "";
      let rec  = "";
if (level == 1) {
  diag = "Stare criticÄƒ la prezentare, stabilizatÄƒ dupÄƒ intervenÈ›ie rapidÄƒ. Nu se mai obiectiveazÄƒ criterii de instabilitate dupÄƒ reevaluÄƒrile succesive.";
  
  evo  = "Pacientul s-a prezentat cu parametri vitali sever alteraÈ›i, necesitÃ¢nd intervenÈ›ie imediatÄƒ. DupÄƒ administrarea tratamentului È™i monitorizare continuÄƒ, statusul clinic s-a ameliorat progresiv, atingÃ¢nd valori stabile È™i predictibile. Nu persistÄƒ semne de deteriorare acutÄƒ.";
  
  rec  = "Se recomandÄƒ monitorizare atentÄƒ la domiciliu, evitarea efortului fizic intens, menÈ›inerea unei bune hidratÄƒri È™i prezentarea de urgenÈ›Äƒ la reapariÈ›ia durerilor severe, dispneei, alterÄƒrii stÄƒrii generale sau oricÄƒrui simptom nou. Reevaluare rapidÄƒ Ã®n ambulator sau la medicul de familie Ã®n 24â€“48 de ore.";
}

else if (level == 2) {
  diag = "Episod acut cu risc moderat, evaluat complet È™i stabilizat Ã®n serviciul de urgenÈ›Äƒ. FÄƒrÄƒ semne clinice sau paraclinice care sÄƒ impunÄƒ internarea.";
  
  evo  = "Simptomatologia iniÈ›ialÄƒ a fost intensÄƒ, necesitÃ¢nd investigaÈ›ii È™i tratament imediat. Pe parcursul supravegherii, parametrii vitali s-au ameliorat, iar evoluÈ›ia a fost favorabilÄƒ, cu dispariÈ›ia progresivÄƒ a simptomelor acute. Nu se evidenÈ›iazÄƒ semne de agravare.";
  
  rec  = "RecomandÄƒm tratament simptomatic conform schemei prescrise, hidratare adecvatÄƒ È™i evitare factori declanÈ™atori. Reevaluare la medicul de familie sau specialist Ã®n 24â€“72 de ore. Prezentare imediatÄƒ la UPU dacÄƒ apar dureri intense, febrÄƒ Ã®naltÄƒ, dispnee, stare de confuzie sau agravarea semnificativÄƒ a simptomelor.";
}

else {
  diag = "Patologie de severitate medie, investigatÄƒ Ã®n ambulator/UPU, cu status hemodinamic stabil. FÄƒrÄƒ criterii care sÄƒ indice necesitatea unei internÄƒri.";
  
  evo  = "Pacientul s-a prezentat cu simptomatologie moderatÄƒ, fÄƒrÄƒ modificÄƒri critice la examenul clinic sau investigaÈ›ii. Pe durata supravegherii, starea generalÄƒ a rÄƒmas constantÄƒ, cu parametri vitali Ã®n limite acceptabile È™i fÄƒrÄƒ semne de progresie acutÄƒ.";
  
  rec  = "RecomandÄƒm monitorizare la domiciliu, regim de viaÈ›Äƒ echilibrat, evitarea suprasolicitÄƒrii È™i urmarea tratamentului prescris. Reevaluare programatÄƒ la medicul de familie sau specialist Ã®n urmÄƒtoarele zile. Prezentare de urgenÈ›Äƒ dacÄƒ apar semne noi sau agravare simptomaticÄƒ.";
}
      if (reason) {
        evo = `Motivul prezentÄƒrii: ${reason}.\n` + evo;
      }

      const diagEl = document.getElementById("diag_txt");
      const evoEl  = document.getElementById("evo_txt");
      const recEl  = document.getElementById("rec_txt");

      if (!diagEl.value) diagEl.value = diag;
      if (!evoEl.value)  evoEl.value  = evo;
      if (!recEl.value)  recEl.value  = rec;
    }

    /* -------------------------------------------------------
       UPLOAD INVESTIGAÈšII PDF
    ------------------------------------------------------- */
    async function uploadInvestigations() {
      const input    = document.getElementById("inv_files");
      const files    = input.files;
      const statusEl = document.getElementById("upload_status");
      const listEl   = document.getElementById("upload_list");

      statusEl.className = "status";
      statusEl.textContent = "";

      if (!files.length) {
        statusEl.textContent = "SelecteazÄƒ cel puÈ›in un fiÈ™ier PDF.";
        statusEl.classList.add("err");
        return;
      }

      for (let file of files) {
        const fd = new FormData();
        fd.append("file", file);

        try {
          const res = await fetch("/api/uploads/investigatie", {
            method: "POST",
            body: fd
          });

          if (!res.ok) {
            const j = await res.json().catch(() => ({}));
            throw new Error(j.detail || "Eroare la Ã®ncÄƒrcarea fiÈ™ierului.");
          }

          const data = await res.json();
          console.log("RÄƒspuns upload:", data);

          const stored =
            data.filename ||
            data.stored_name ||
            data.file ||
            data.name;

          if (!stored) {
            console.error("RÄƒspuns backend fÄƒrÄƒ nume de fiÈ™ier:", data);
            continue; // nu Ã®l adÄƒugÄƒm Ã®n listÄƒ
          }

          // reÈ›inem numele real folosit de backend
          uploadedInvestigations.push(stored);

          const li = document.createElement("li");
          li.textContent = `${file.name} â†’ ${stored}`;
          listEl.appendChild(li);

        } catch (e) {
          console.error(e);
          statusEl.textContent = "Eroare la Ã®ncÄƒrcarea unor fiÈ™iere.";
          statusEl.classList.add("err");
          return;
        }
      }

      statusEl.textContent = "FiÈ™iere Ã®ncÄƒrcate cu succes.";
      statusEl.classList.add("ok");
      input.value = "";
    }

    /* -------------------------------------------------------
       GENERARE PDF FINAL
    ------------------------------------------------------- */
    async function generatePdf() {
      const statusEl = document.getElementById("pdf_status");
      statusEl.className = "status";
      statusEl.textContent = "Se genereazÄƒ PDF-ul...";

      const patientName =
        ((document.getElementById("p_first_name").value || "") + " " +
         (document.getElementById("p_last_name").value  || "")).trim();

      const payload = {
        patient_name: patientName,
        cnp: document.getElementById("p_cnp").value || null,
        age: null,
        sex: null,

        diagnosis:       document.getElementById("diag_txt").value || "",
        evolution:       document.getElementById("evo_txt").value  || "",
        recommendations: document.getElementById("rec_txt").value  || "",

        triage_level: Number(document.getElementById("p_triage_level").value || 0),
        triage_color: null,
        reason: null,

        // aici trimitem efectiv fiÈ™ierele Ã®ncÄƒrcate
        investigations: uploadedInvestigations
      };

      if (!payload.patient_name) {
        statusEl.textContent = "Nu existÄƒ date despre pacient (nume).";
        statusEl.classList.add("err");
        return;
      }
      if (!payload.diagnosis.trim()) {
        statusEl.textContent = "CompleteazÄƒ diagnosticul la externare.";
        statusEl.classList.add("err");
        return;
      }

      try {
        const res = await fetch("/api/pdf/externare", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const j = await res.json().catch(() => ({}));
          console.error("Eroare backend /api/pdf/externare:", j);
          throw new Error(j.detail || "Eroare la generarea PDF-ului.");
        }

        const blob = await res.blob();
        const url  = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `externare_${payload.patient_name.replace(/\s+/g,"_")}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        statusEl.textContent = "PDF generat È™i descÄƒrcat cu succes.";
        statusEl.classList.add("ok");
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Eroare la generarea PDF-ului.";
        statusEl.classList.add("err");
      }
    }

    /* -------------------------------------------------------
       INIT
    ------------------------------------------------------- */
    document.addEventListener("DOMContentLoaded", () => {
      loadLastTriage();
      document.getElementById("btn_ai_draft")
        .addEventListener("click", generateAiDraft);
      document.getElementById("btn_upload_inv")
        .addEventListener("click", uploadInvestigations);
      document.getElementById("btn_generate_pdf")
        .addEventListener("click", generatePdf);
    });
  </script>
</body>
</html>